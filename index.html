<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Editor v0.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Noto Serif KR', serif; 
            display: flex; height: 100vh; background: #08080c;
            overflow: hidden;
        }

        /* â”€â”€ ì—ë””í„° íŒ¨ë„ â”€â”€ */
        .editor-panel { 
            width: 440px; background: #0e0e14; 
            border-right: 1px solid #1a1a24; 
            display: flex; flex-direction: column;
            color: #c0c0d0;
        }

        /* â”€â”€ íƒ­ í—¤ë” â”€â”€ */
                 /* â”€â”€ [ìˆ˜ì •ë¨] íƒ­ í—¤ë” ì˜ì—­ â”€â”€ */
        .tab-header {
            display: flex;             /* ë²„íŠ¼ ê°€ë¡œ ì •ë ¬ í•µì‹¬ */
            width: 100%;
            border-bottom: 1px solid #1a1a24;
            background: #0e0e14;
            flex-shrink: 0;            /* ìŠ¤í¬ë¡¤ ì‹œ ì°Œê·¸ëŸ¬ì§ ë°©ì§€ */
        }

        /* â”€â”€ [ìˆ˜ì •ë¨] íƒ­ ë²„íŠ¼ ë””ìì¸ â”€â”€ */
        .tab-btn {
            flex: 1;                   /* ê³µê°„ ê· ë“± ë¶„í•  */
            padding: 12px 0; 
            text-align: center;
            font-size: 13px;           /* ê¸€ì”¨ í¬ê¸° 13pxë¡œ ìœ ì§€ */
            font-weight: 600; 
            letter-spacing: 0.05em;
            color: #8080a0;            /* ê¸°ë³¸ ìƒ‰ìƒ: ë°ì€ ë¼ë²¤ë” */
            background: transparent;
            border: none; 
            border-bottom: 2px solid transparent; /* í•˜ë‹¨ ì„  ê³µê°„ í™•ë³´ */
            cursor: pointer; 
            transition: all 0.2s;
        }

        .tab-btn:hover { 
            color: #c0c0e0; 
            background: #121218;       /* í˜¸ë²„ ì‹œ ë°°ê²½ ì‚´ì§ ë°ê²Œ */
        }

        .tab-btn.active { 
            color: #ffffff; 
            border-bottom-color: #7070e0; /* í™œì„± íƒ­ í•˜ë‹¨ ë³´ë¼ìƒ‰ ì„  */
            background: #161620;          /* í™œì„± íƒ­ ë°°ê²½ */
        }
 /* â”€â”€ íƒ­ ë‚´ìš© â”€â”€ */
        .tab-content {
            flex: 1; overflow-y: auto; padding: 16px;
            padding-bottom: 100px;
            display: none; flex-direction: column; gap: 10px;
        }
        .tab-content.active { display: flex; }

                /* â”€â”€ [ìˆ˜ì •] ë¯¸ë¦¬ë³´ê¸° íŒ¨ë„: ê¸°ì¤€ì (relative) ì¶”ê°€ â”€â”€ */
        .preview-panel { 
            flex: 1; padding: 24px; overflow-y: auto; 
            display: flex; justify-content: center; 
            background: #050508; align-items: flex-start;
            
            /* â˜… ì´ ì†ì„±ì´ ì—†ì–´ì„œ ë²„íŠ¼ì´ í™”ë©´ ìœ„ë¡œ ë‚ ì•„ê°”ë˜ ê²ë‹ˆë‹¤! */
            position: relative; 
        }
        #preview-container { width: 100%; max-width: 720px; }

                /* â”€â”€ [ìˆ˜ì •] í•˜ë‹¨ ì•¡ì…˜ë°”: ë²„íŠ¼ ì¤„ë°”ê¿ˆ í—ˆìš© â”€â”€ */
        .action-bar { 
            flex-shrink: 0; 
            background: #0a0a10; 
            border-top: 1px solid #1a1a24; 
            padding: 10px 12px; 
            display: flex; 
            gap: 6px; 
            align-items: center;
            
            /* í•µì‹¬: ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ì´ ë§ìœ¼ë©´ ë‹¤ìŒ ì¤„ë¡œ ë„˜ê¹€ */
            flex-wrap: wrap; 
        }

        /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ë“¤ì´ ê½‰ ì°¨ê²Œ ë³´ì´ë„ë¡ ì¡°ì • */
        .action-bar .btn {
            flex: 1 1 auto; /* ë‚¨ëŠ” ê³µê°„ ì±„ìš°ê¸° */
            text-align: center;
            min-width: 60px; /* ë„ˆë¬´ ì‘ì•„ì§€ì§€ ì•Šê²Œ ë°©ì§€ */
            font-size: 12px;
            padding: 8px 4px; /* íŒ¨ë”© ì¡°ì ˆ */
        }

        /* ì €ì¥ ì‹œê°„ í‘œì‹œëŠ” í•œ ì¤„ ì „ì²´ ì°¨ì§€í•´ì„œ ë§¨ ì•„ë˜ë¡œ */
        .autosave-indicator { 
            width: 100%; 
            margin-top: 8px; 
            justify-content: flex-end; 
            order: 99; /* ê°•ì œë¡œ ë§¨ ë ìˆœì„œ */
            padding-right: 4px;
        }
        .char-count { font-size: 10px; color: #505070; margin-left: auto; }

                       /* â”€â”€ [ìˆ˜ì •] ëª¨ë°”ì¼ ìµœì í™” (900px ì´í•˜) â”€â”€ */
        @media (max-width: 900px) {
            body { 
                flex-direction: column; 
                overflow: auto; 
                height: auto; 
            }
            .editor-panel { 
                width: 100%; 
                height: auto; 
                border-right: none;
                border-bottom: 1px solid #1a1a24;
            }
            
            .preview-panel { 
                min-height: 600px; 
                display: flex; 
                flex-direction: column;
                padding-top: 0;
                position: relative; /* ì¤‘ìš”: ê¸°ì¤€ì  ì¡ê¸° */
            }

            /* â˜… ìˆ˜ì •ë¨: ì»¨íŠ¸ë¡¤ ë°•ìŠ¤ë¥¼ ì¤‘ì•™ì— ì˜ˆì˜ê²Œ ëª¨ìŒ */
            .preview-controls {
                position: static;   /* ë‘¥ë‘¥ ëœ¨ì§€ ì•Šê³  ì œìë¦¬ì— */
                width: 100%;
                margin: 0;
                padding: 16px;
                background: #14141a;
                border-bottom: 1px solid #2a2a3a;
                border-radius: 0;
                
                /* í•µì‹¬: ì–‘ìª½ ëì´ ì•„ë‹ˆë¼ ê°€ìš´ë°ë¡œ ëª¨ìœ¼ê¸° */
                display: flex;
                justify-content: center; 
                align-items: center;
                gap: 24px;          /* í™•ëŒ€ ë²„íŠ¼ê³¼ í† ê¸€ ì‚¬ì´ ê°„ê²© */
            }
        }





        /* â”€â”€ ê³µí†µ UI â”€â”€ */
        .section-box { 
            background: #121218; border: 1px solid #1e1e28; 
            padding: 12px; border-radius: 10px; 
        }
        .section-title { 
            font-size: 12px; /* 9px -> 12px í™•ëŒ€ */
            font-weight: 700; margin-bottom: 12px; 
            color: #8080d0; /* ë” ì„ ëª…í•œ ë³´ë¼ìƒ‰ */
            text-transform: uppercase; letter-spacing: 0.1em;
            display: flex; align-items: center; gap: 8px;
        }
        .form-group { margin-bottom: 8px; }
           .form-group label { 
            display: block; 
            font-size: 12px; /* 9px -> 12px í™•ëŒ€ */
            font-weight: 600; 
            color: #a0a0c0; /* ì˜ ì•ˆë³´ì´ë˜ íšŒìƒ‰ -> ë°ì€ íšŒìƒ‰ */
            margin-bottom: 5px; 
            text-transform: none; /* ëŒ€ë¬¸ì ê°•ì œ ì œê±°í•´ì„œ ê°€ë…ì„± ë†’ì„ */
            letter-spacing: 0;
        }
         input, textarea, select { 
            width: 100%; padding: 10px 12px; /* íŒ¨ë”© ì¦ê°€ */
            border: 1px solid #2a2a3a; border-radius: 6px; 
            font-size: 14px; /* 12px -> 14px í™•ëŒ€ */
            font-family: inherit; 
            background: #0a0a10; 
            color: #e0e0f0; /* ê¸€ì”¨ ê±°ì˜ í°ìƒ‰ì— ê°€ê¹ê²Œ */
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #5050a0; }
        textarea { resize: vertical; min-height: 55px; }
        
          .btn { 
            padding: 10px 16px; border-radius: 6px; cursor: pointer; 
            font-size: 13px; /* 11px -> 13px */
            font-weight: 600; border: none; transition: all 0.2s;
        }
        .btn-primary { background: linear-gradient(135deg, #4848a0, #6060c0); color: white; }
        .btn-primary:hover { background: linear-gradient(135deg, #5858b0, #7070d0); }
        .btn-outline { border: 1px solid #303048; color: #8888a8; background: transparent; }
        .btn-outline:hover { background: #16161e; }
        .btn-danger { border: 1px solid #804040; color: #c07070; background: transparent; }
        .btn-danger:hover { background: #1e1214; }
        .btn-sm { padding: 6px 12px; font-size: 11px; }
     
        .btn-shortcut { 
            background: #18181e; padding: 3px 8px; 
            border-radius: 4px; font-size: 10px; cursor: pointer; 
            border: 1px solid #252530; margin-right: 3px;
            color: #8888a8; transition: all 0.15s;
        }
        .btn-shortcut:hover { background: #252530; }

        /* â”€â”€ í…Œë§ˆ ê·¸ë¦¬ë“œ â”€â”€ */
        .theme-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 8px; }
        .theme-opt { 
            height: 48px; border-radius: 8px; cursor: pointer; 
            border: 2px solid transparent; font-size: 7px; 
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; font-weight: 700; transition: all 0.15s;
            gap: 2px; letter-spacing: 0.05em;
        }
        .theme-opt:hover { transform: scale(1.03); }
        .theme-opt.active { border-color: #6060c0; box-shadow: 0 0 16px rgba(96,96,192,0.3); }

        .toggle-row { display: flex; align-items: center; gap: 8px; padding: 6px 0; }
        .toggle-row input[type="checkbox"] { width: auto; accent-color: #6060c0; }
        .toggle-row label { margin: 0; font-size: 10px; color: #7070a0; cursor: pointer; }

        /* â”€â”€ ì»¤ìŠ¤í…€ í…Œë§ˆ â”€â”€ */
        .custom-theme-editor { margin-top: 8px; padding: 10px; background: #0a0a10; border: 1px solid #1e1e28; border-radius: 8px; }
        .color-row { display: flex; align-items: center; gap: 6px; margin-bottom: 5px; }
        .color-row label { font-size: 9px; color: #505070; width: 80px; flex-shrink: 0; margin: 0; }
        .color-row input[type="color"] { width: 28px; height: 22px; padding: 1px; border-radius: 4px; flex-shrink: 0; }
        .color-row input[type="text"] { flex: 1; padding: 4px 6px; font-size: 10px; }

        /* â”€â”€ ì¸ë¬¼ ì¹´ë“œ â”€â”€ */
        .char-card {
            background: #0a0a10; border: 1px solid #1e1e28;
            border-radius: 8px; padding: 10px; margin-bottom: 8px;
        }
        .char-card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }

        /* â”€â”€ ì±•í„° â”€â”€ */
        .chapter-box { background: #14141a; border-color: #24243a; }
        .log-entry { 
            border: 1px solid #1e1e28; padding: 8px; 
            border-radius: 6px; margin-bottom: 6px; background: #0e0e14; 
        }

        /* â”€â”€ ì»¤ë²„ ë ˆì´ì•„ì›ƒ ì„ íƒ â”€â”€ */
        .layout-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 8px; }
        .layout-opt {
            padding: 10px 6px; border-radius: 8px; cursor: pointer;
            border: 2px solid #1e1e28; font-size: 8px; text-align: center;
            color: #7070a0; background: #0a0a10; transition: all 0.15s;
            font-weight: 600; letter-spacing: 0.05em;
        }
        .layout-opt:hover { border-color: #404060; }
        .layout-opt.active { border-color: #6060c0; box-shadow: 0 0 12px rgba(96,96,192,0.2); }

        /* â”€â”€ ê·¸ë¼ë°ì´ì…˜ í”„ë¦¬ì…‹ â”€â”€ */
        .gradient-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-bottom: 8px; }
        .gradient-opt {
            height: 36px; border-radius: 6px; cursor: pointer;
            border: 2px solid transparent; transition: all 0.15s;
        }
        .gradient-opt:hover { transform: scale(1.05); }
        .gradient-opt.active { border-color: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.3); }

        /* â”€â”€ ì´ë¯¸ì§€ íƒœê·¸ ë³µì‚¬ ì˜ì—­ â”€â”€ */
        .imgtag-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .imgtag-btn {
            padding: 10px 6px; border-radius: 8px; cursor: pointer;
            border: 1px solid #1e1e28; font-size: 9px; text-align: center;
            color: #7070a0; background: #0a0a10; transition: all 0.15s;
        }
        .imgtag-btn:hover { background: #16161e; border-color: #404060; }

        /* â”€â”€ ëª¨ë‹¬ â”€â”€ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
        }
        .modal-box {
            width: 90%; max-width: 800px; height: 80%; margin: 5% auto;
            background: #121218; border: 1px solid #2a2a3a; border-radius: 12px;
            display: flex; flex-direction: column;
        }
        .modal-header {
            padding: 16px 20px; border-bottom: 1px solid #2a2a3a;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-footer {
            padding: 16px 20px; border-top: 1px solid #2a2a3a; text-align: right;
        }

        /* â•â•â•â•â•â•â•â•â•â• ìƒˆë¡œìš´ ê¸°ëŠ¥ CSS â•â•â•â•â•â•â•â•â•â• */
        
        /* ìë™ì €ì¥ í‘œì‹œ */
        .autosave-indicator {
            font-size: 9px; color: #505070; margin-left: auto;
            display: flex; align-items: center; gap: 6px;
        }
        .autosave-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: #4a8f5a; animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* ë¯¸ë¦¬ë³´ê¸° ì»¨íŠ¸ë¡¤ */
        .preview-controls {
            position: absolute; top: 16px; right: 16px;
            display: flex; gap: 8px; align-items: center;
            background: rgba(10, 10, 16, 0.95); padding: 8px 12px;
            border-radius: 8px; border: 1px solid #1a1a24;
            z-index: 10;
        }
        .preview-controls label {
            font-size: 9px; color: #505070; margin: 0;
        }
        .zoom-control {
            display: flex; align-items: center; gap: 6px;
        }
        .zoom-btn {
            width: 24px; height: 24px; border-radius: 4px;
            background: #18181e; border: 1px solid #252530;
            color: #8888a8; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            font-size: 14px; transition: all 0.15s;
        }
        .zoom-btn:hover { background: #252530; }
        .zoom-value {
            font-size: 10px; color: #8888a8; min-width: 40px;
            text-align: center;
        }

        /* íƒ€ì„ë¼ì¸ */
        .timeline-view {
            position: fixed; left: 16px; top: 50%; transform: translateY(-50%);
            width: 200px; max-height: 80vh; overflow-y: auto;
            background: rgba(14, 14, 20, 0.98); border: 1px solid #1a1a24;
            border-radius: 12px; padding: 12px; z-index: 1000;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
        }
        .timeline-header {
            font-size: 10px; font-weight: 700; color: #6060a0;
            text-transform: uppercase; letter-spacing: 0.1em;
            margin-bottom: 12px; padding-bottom: 8px;
            border-bottom: 1px solid #1a1a24;
        }
        .timeline-item {
            padding: 8px 10px; margin-bottom: 6px; border-radius: 6px;
            background: #121218; border-left: 3px solid #6060c0;
            cursor: pointer; transition: all 0.15s;
        }
        .timeline-item:hover { background: #18181e; transform: translateX(3px); }
        .timeline-item-title {
            font-size: 11px; font-weight: 600; color: #c0c0d0;
            margin-bottom: 2px;
        }
        .timeline-item-info {
            font-size: 8px; color: #7070a0;
        }
        .timeline-close {
            position: absolute; top: 10px; right: 10px;
            width: 24px; height: 24px; border-radius: 4px;
            background: #18181e; border: 1px solid #252530;
            color: #8888a8; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            font-size: 16px;
        }
        .timeline-close:hover { background: #252530; }

        /* ê²€ìƒ‰ & ì¹˜í™˜ ëª¨ë‹¬ */
        .search-modal {
            display: none; position: fixed; z-index: 10000;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); align-items: center;
            justify-content: center;
        }
        .search-modal.active { display: flex; }
        .search-modal-content {
            background: #121218; border-radius: 12px;
            width: 90%; max-width: 500px; padding: 20px;
            border: 1px solid #2a2a3a;
        }
        .search-modal-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 16px;
            padding-bottom: 12px; border-bottom: 1px solid #1a1a24;
        }
        .search-modal-title {
            font-size: 14px; font-weight: 700; color: #c0c0d0;
        }
        .search-modal-close {
            width: 28px; height: 28px; border-radius: 4px;
            background: #18181e; border: 1px solid #252530;
            color: #8888a8; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            font-size: 18px;
        }
        .search-modal-close:hover { background: #252530; }
        .search-results {
            max-height: 200px; overflow-y: auto;
            background: #0a0a10; border: 1px solid #1e1e28;
            border-radius: 6px; padding: 8px; margin-top: 12px;
        }
        .search-result-item {
            padding: 6px 8px; margin-bottom: 4px;
            background: #121218; border-radius: 4px;
            font-size: 11px; color: #8888a8;
            cursor: pointer; transition: all 0.15s;
        }
        .search-result-item:hover { background: #18181e; }
        .search-result-preview {
            font-size: 10px; color: #505070;
            margin-top: 2px;
        }

        /* ìŠ¬ë¡¯ ëª¨ë‹¬ */
        .slot-list {
            margin-top: 12px;
        }
        .slot-item {
            padding: 12px; margin-bottom: 8px;
            background: #0a0a10; border: 1px solid #1e1e28;
            border-radius: 8px; cursor: pointer;
            transition: all 0.15s;
        }
        .slot-item:hover { background: #121218; border-color: #6060c0; }
        .slot-item-title {
            font-size: 12px; font-weight: 600; color: #c0c0d0;
            margin-bottom: 4px;
        }
        .slot-item-time {
            font-size: 9px; color: #7070a0;
        }
        .slot-item-empty {
            text-align: center; color: #505070;
            font-size: 11px; padding: 24px;
        }

        /* í…œí”Œë¦¿ */
        .template-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 10px; margin-top: 12px;
        }
        .template-card {
            padding: 14px; background: #0a0a10;
            border: 2px solid #1e1e28; border-radius: 10px;
            cursor: pointer; transition: all 0.15s;
        }
        .template-card:hover {
            border-color: #6060c0;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(96,96,192,0.2);
        }
        .template-card-name {
            font-size: 12px; font-weight: 700; color: #c0c0d0;
            margin-bottom: 6px;
        }
        .template-card-desc {
            font-size: 9px; color: #7070a0;
            line-height: 1.4;
        }
        .template-card-preview {
            height: 60px; margin-top: 8px; border-radius: 6px;
            background: linear-gradient(135deg, #0a0a1a, #1a1a2a);
            border: 1px solid #1e1e28;
        }

        /* ë‹¨ì¶•í‚¤ íŒíŠ¸ */
        .shortcut-hint {
            position: fixed; bottom: 16px; right: 16px;
            background: rgba(10, 10, 16, 0.95);
            border: 1px solid #1a1a24; border-radius: 8px;
            padding: 10px 14px; font-size: 9px; color: #7070a0;
            z-index: 999; display: none;
        }
        .shortcut-hint.active { display: block; }
        .shortcut-hint kbd {
            background: #18181e; padding: 2px 6px;
            border-radius: 3px; border: 1px solid #252530;
            margin: 0 2px; font-family: monospace;
        }
    </style>
</head>
<body>

<div class="editor-panel">
    <!-- íƒ­ í—¤ë” -->
    <div class="tab-header">
        <button class="tab-btn active" onclick="switchTab('cover', this)">í‘œì§€</button>
        <button class="tab-btn" onclick="switchTab('chars', this)">ì¸ë¬¼</button>
        <button class="tab-btn" onclick="switchTab('content', this)">ë³¸ë¬¸</button>
        <button class="tab-btn" onclick="switchTab('settings', this)">ì„¤ì •</button>
    </div>

    <!-- â•â•â•â•â•â•â• íƒ­1: í‘œì§€ â•â•â•â•â•â•â• -->
    <div class="tab-content active" id="tab-cover">
        <div class="section-box">
            <div class="section-title">ì»¤ë²„ ë ˆì´ì•„ì›ƒ</div>
            <div class="layout-grid">
                <div class="layout-opt active" onclick="setCoverLayout('default', this)">
                    <div style="font-size:16px; margin-bottom:4px;">â–£</div>ê¸°ë³¸
                </div>
                <div class="layout-opt" onclick="setCoverLayout('noimage', this)">
                    <div style="font-size:16px; margin-bottom:4px;">â—§</div>ì´ë¯¸ì§€ì—†ìŒ
                </div>
                <div class="layout-opt" onclick="setCoverLayout('split', this)">
                    <div style="font-size:16px; margin-bottom:4px;">â—¨</div>ë¶„í• í˜•
                </div>
            </div>
        </div>

        <!-- ê¸°ë³¸/ë¶„í• í˜•ì¼ ë•Œ ì´ë¯¸ì§€ URL -->
        <div class="section-box" id="coverImgSection">
            <div class="section-title">í‘œì§€ ì´ë¯¸ì§€</div>
            <div class="form-group"><label>ì´ë¯¸ì§€ URL</label><input type="text" id="coverImg" value="" placeholder="//ac..." oninput="renderPreview()"></div>
        </div>

        <!-- ì´ë¯¸ì§€ì—†ìŒì¼ ë•Œ ê·¸ë¼ë°ì´ì…˜ -->
        <div class="section-box" id="gradientSection" style="display:none;">
            <div class="section-title">í‘œì§€ ë°°ê²½</div>
            <div class="gradient-grid" id="gradientGrid">
                <div class="gradient-opt active" onclick="setGradient(0, this)" style="background:linear-gradient(135deg, #0a0a1a, #1a1a3a);"></div>
                <div class="gradient-opt" onclick="setGradient(1, this)" style="background:linear-gradient(135deg, #1a0a1a, #3a1a2a);"></div>
                <div class="gradient-opt" onclick="setGradient(2, this)" style="background:linear-gradient(135deg, #0a1a1a, #1a3a3a);"></div>
                <div class="gradient-opt" onclick="setGradient(3, this)" style="background:linear-gradient(135deg, #1a1a0a, #3a3a1a);"></div>
                <div class="gradient-opt" onclick="setGradient(4, this)" style="background:linear-gradient(135deg, #f0e8e0, #e0d0c0);"></div>
                <div class="gradient-opt" onclick="setGradient(5, this)" style="background:linear-gradient(135deg, #e8e0f0, #d0c0e0);"></div>
            </div>
            <div style="display:flex; gap:6px; margin-top:6px;">
                <div class="form-group" style="flex:1;"><label>ìƒ‰ìƒ 1</label><input type="color" id="gradColor1" value="#0a0a1a" oninput="renderPreview()"></div>
                <div class="form-group" style="flex:1;"><label>ìƒ‰ìƒ 2</label><input type="color" id="gradColor2" value="#1a1a3a" oninput="renderPreview()"></div>
                <div class="form-group" style="flex:1;"><label>ë°©í–¥(Â°)</label><input type="number" id="gradAngle" value="135" min="0" max="360" oninput="renderPreview()"></div>
            </div>
        </div>

        <div class="section-box">
            <div class="section-title">í‘œì§€ ì •ë³´</div>
            <div class="form-group"><label>ì œëª©</label><input type="text" id="coverTitle" value="Story Title" oninput="renderPreview()"></div>
            <div class="form-group"><label>ë¶€ì œ</label><input type="text" id="coverSubtitle" value="A Ã— B" oninput="renderPreview()"></div>
            <div style="display:flex; gap:6px;">
                <div class="form-group" style="flex:1;"><label>ë‚ ì§œ</label><input type="text" id="dateText" value="ë‚ ì§œ" oninput="renderPreview()"></div>
                <div class="form-group" style="flex:1;"><label>ë¶„ë¥˜</label><input type="text" id="tagText" value="FICTION" oninput="renderPreview()"></div>
            </div>
        </div>

        <div class="section-box">
            <div class="section-title">í•´ì‹œíƒœê·¸</div>
            <input type="text" id="hashTags" value="íƒœê·¸1,íƒœê·¸2,íƒœê·¸3" oninput="renderPreview()" placeholder="ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„">
        </div>
    </div>

    <!-- â•â•â•â•â•â•â• íƒ­2: ì¸ë¬¼ â•â•â•â•â•â•â• -->
    <div class="tab-content" id="tab-chars">
        <div class="section-box">
            <div class="section-title">
                <span>ì¸ë¬¼ ëª©ë¡</span>
            </div>
            <div class="toggle-row">
                <input type="checkbox" id="showCharIntro" checked onchange="renderPreview()">
                <label for="showCharIntro">ì¸ë¬¼ ì†Œê°œ ì„¹ì…˜ í‘œì‹œ</label>
            </div>
            <div id="chars-container"></div>
            <button class="btn btn-outline" style="width:100%; margin-top:8px;" onclick="addCharacter()">+ ì¸ë¬¼ ì¶”ê°€</button>
        </div>

        <div class="section-box" id="relationSection">
            <div class="section-title">ê´€ê³„ë„ (2ì¸ ì „ìš©)</div>
            <p style="font-size:10px; color:#505070; line-height:1.6;">ì¸ë¬¼ì´ 2ëª…ì¼ ë•Œë§Œ ê´€ê³„ë„ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
            <div class="form-group" style="margin-top:8px;"><label>ì¸ë¬¼1 â†’ ì¸ë¬¼2</label><input type="text" id="relation12" value="ìƒëŒ€ë¥¼ í–¥í•œ í•œ ë§ˆë””" oninput="renderPreview()"></div>
            <div class="form-group"><label>ì¸ë¬¼2 â†’ ì¸ë¬¼1</label><input type="text" id="relation21" value="ìƒëŒ€ë¥¼ í–¥í•œ í•œ ë§ˆë””" oninput="renderPreview()"></div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â• íƒ­3: ë³¸ë¬¸ â•â•â•â•â•â•â• -->
    <div class="tab-content" id="tab-content">
        <div id="chapters-container"></div>
        
        <div class="section-box" style="padding:8px 12px;">
            <div class="toggle-row">
                <input type="checkbox" id="useCollapse" checked onchange="renderPreview()">
                <label for="useCollapse">ì±•í„° ì ‘ê¸°/í¼ì¹˜ê¸°</label>
            </div>
        </div>
        
        <button class="btn btn-outline" onclick="addChapter()" style="width:100%;">+ ì±•í„° ì¶”ê°€</button>

        <div class="section-box">
            <div class="section-title">í•˜ë‹¨</div>
            <div class="form-group"><label>ì‘ì„±ì</label><input type="text" id="authorName" value="ì´ë¦„" oninput="renderPreview()"></div>
            <div class="toggle-row">
                <input type="checkbox" id="showNote" checked onchange="renderPreview()">
                <label for="showNote">ì½”ë©˜íŠ¸ í‘œì‹œ</label>
            </div>
            <div class="form-group"><label>ì½”ë©˜íŠ¸</label><textarea id="commentText" oninput="renderPreview()">ì½”ë©˜íŠ¸</textarea></div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â• íƒ­4: ì„¤ì • â•â•â•â•â•â•â• -->
    <div class="tab-content" id="tab-settings">             
        <div class="section-box">
            <div class="section-title">í…Œë§ˆ</div>
            <div class="theme-grid" id="themeGrid">
                <div class="theme-opt active" onclick="setTheme('obsidian', this)" style="background:linear-gradient(135deg,#0a0a0f,#14141c); color:#d0d0e8;">OBSIDIAN</div>
                <div class="theme-opt" onclick="setTheme('vintage', this)" style="background:linear-gradient(135deg,#f4efe4,#e8e0d0); color:#3a352a;">VINTAGE</div>
                <div class="theme-opt" onclick="setTheme('cherry', this)" style="background:linear-gradient(135deg,#fff8fa,#ffe8f0); color:#8a4a60;">CHERRY</div>
                <div class="theme-opt" onclick="setTheme('pure', this)" style="background:linear-gradient(135deg,#ffffff,#f5f5f5); color:#1a1a1a; border:1px solid #ddd;">PURE</div>
                <div class="theme-opt" onclick="setTheme('violet', this)" style="background:linear-gradient(135deg,#1a1420,#241830); color:#d8c0e8;">VIOLET</div>
            </div>
            <div class="toggle-row">
                <input type="checkbox" id="useCustomTheme" onchange="toggleCustomTheme()">
                <label for="useCustomTheme">ì»¤ìŠ¤í…€ í…Œë§ˆ ì‚¬ìš©</label>
            </div>
            <div class="custom-theme-editor" id="customThemeEditor" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span style="font-size:9px; font-weight:600; color:#6060a0; letter-spacing:0.1em;">CUSTOM COLORS</span>
                    <div>
                        <button class="btn-shortcut" onclick="loadPresetIntoCustom()">í”„ë¦¬ì…‹ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button class="btn-shortcut" onclick="saveCustomTheme()">ğŸ’¾ ì €ì¥</button>
                    </div>
                </div>
                <div class="color-row"><label>ë°°ê²½ (wrap)</label><input type="color" id="ct_wrapBg" value="#08080c" oninput="syncColorText(this)"><input type="text" data-for="ct_wrapBg" value="#08080c" oninput="syncColorPicker(this)"></div>
                <div class="color-row"><label>ì¹´ë“œ ë°°ê²½</label><input type="color" id="ct_cardBg" value="#0c0c12" oninput="syncColorText(this)"><input type="text" data-for="ct_cardBg" value="#0c0c12" oninput="syncColorPicker(this)"></div>
                <div class="color-row"><label>ë³¸ë¬¸ ë°°ê²½</label><input type="color" id="ct_contentBg" value="#0a0a0e" oninput="syncColorText(this)"><input type="text" data-for="ct_contentBg" value="#0a0a0e" oninput="syncColorPicker(this)"></div>
                <div class="color-row"><label>í—¤ë” ë°°ê²½</label><input type="color" id="ct_headerBg" value="#0e0e14" oninput="syncColorText(this)"><input type="text" data-for="ct_headerBg" value="#0e0e14" oninput="syncColorPicker(this)"></div>
                <div class="color-row"><label>ë³¸ë¬¸ í…ìŠ¤íŠ¸</label><input type="color" id="ct_text" value="#d8d8e8" oninput="syncColorText(this)"><input type="text" data-for="ct_text" value="#d8d8e8" oninput="syncColorPicker(this)"></div>
                <div class="color-row"><label>ë³´ì¡° í…ìŠ¤íŠ¸</label><input type="color" id="ct_textSoft" value="#a0a0b8" oninput="syncColorText(this)"><input type="text" data-for="ct_textSoft" value="#a0a0b8" oninput="syncColorPicker(this)"></div>
                <div class="color-row"><label>íë¦° í…ìŠ¤íŠ¸</label><input type="color" id="ct_textMuted" value="#606078" oninput="syncColorText(this)"><input type="text" data-for="ct_textMuted" value="#606078" oninput="syncColorPicker(this)"></div>
                <div class="color-row"><label>ê°•ì¡°ìƒ‰</label><input type="color" id="ct_accent" value="#8080c0" oninput="syncColorText(this)"><input type="text" data-for="ct_accent" value="#8080c0" oninput="syncColorPicker(this)"></div>
                <div class="color-row"><label>í…Œë‘ë¦¬</label><input type="color" id="ct_border" value="#1a1a28" oninput="syncColorText(this)"><input type="text" data-for="ct_border" value="#1a1a28" oninput="syncColorPicker(this)"></div>
                <div class="color-row"><label>êµ¬ë¶„ì„ </label><input type="color" id="ct_divider" value="#18182a" oninput="syncColorText(this)"><input type="text" data-for="ct_divider" value="#18182a" oninput="syncColorPicker(this)"></div>
            </div>
        </div>

        <div class="section-box">
            <div class="section-title">í°íŠ¸</div>
            <div class="form-group">
                <select id="fontSelect" onchange="onFontChange(); renderPreview();">
                    <option value="'Noto Serif KR', serif">Noto Serif KR</option>
                    <option value="'Nanum Myeongjo', serif">Nanum Myeongjo</option>
                    <option value="'Pretendard', sans-serif">Pretendard</option>
                    <option value="'KoPub Batang', serif">KoPub Batang</option>
                    <option value="custom">ì§ì ‘ ì…ë ¥</option>
                </select>
            </div>
            <div class="form-group" id="customFontGroup" style="display:none;">
                <label>í°íŠ¸ëª…</label>
                <input type="text" id="customFontName" placeholder="ì˜ˆ: 'MapoFlowerIsland'" oninput="renderPreview()">
            </div>
        </div>

        <div class="section-box">
            <div class="section-title">ìë™ ë³€í™˜</div>
            <div class="toggle-row">
                <input type="checkbox" id="autoEllipsis" checked>
                <label for="autoEllipsis">... â†’ â‹¯</label>
            </div>
            <div class="toggle-row">
                <input type="checkbox" id="autoEmdash" checked>
                <label for="autoEmdash">-- â†’ â€”</label>
            </div>
        </div>

        <div class="section-box">
            <div class="section-title">ì´ë¯¸ì§€ íƒœê·¸ ë³µì‚¬</div>
            <p style="font-size:10px; color:#505070; line-height:1.6; margin-bottom:8px;">
                HTML ë¶™ì—¬ë„£ê¸° í›„, ì›í•˜ëŠ” ìœ„ì¹˜ì— ì•„ë˜ íƒœê·¸ë¥¼ ì‚½ì…í•˜ì„¸ìš”.
            </p>
            <div class="imgtag-grid">
                <div class="imgtag-btn" onclick="copyImgTag('basic')">
                    <div style="font-size:14px; margin-bottom:4px;">ğŸ–¼</div>ê¸°ë³¸
                </div>
                <div class="imgtag-btn" onclick="copyImgTag('caption')">
                    <div style="font-size:14px; margin-bottom:4px;">ğŸ–¼</div>ìº¡ì…˜
                </div>
                <div class="imgtag-btn" onclick="copyImgTag('full')">
                    <div style="font-size:14px; margin-bottom:4px;">ğŸ–¼</div>ì „í­
                </div>
            </div>
        </div>

        <div class="section-box">
            <div class="section-title">ë°ì´í„°</div>
            <div style="display:flex; gap:6px;">
                <button class="btn btn-outline" style="flex:1;" onclick="exportJSON()">ğŸ’¾ JSON ì €ì¥</button>
                <label class="btn btn-outline" style="flex:1; text-align:center; cursor:pointer;">
                    ğŸ“‚ JSON ë¶ˆëŸ¬ì˜¤ê¸°
                    <input type="file" accept=".json" onchange="importJSON(event)" style="display:none;">
                </label>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ì•¡ì…˜ë°” -->
    <div class="action-bar">
        <button class="btn btn-sm btn-outline" onclick="toggleTimeline()">ğŸ“Š íƒ€ì„ë¼ì¸</button>
        <button class="btn btn-sm btn-outline" onclick="openSearchModal()">ğŸ” ê²€ìƒ‰</button>
        <button class="btn btn-sm btn-outline" onclick="openAutoSaveModal()">ğŸ’¾ ì €ì¥ë‚´ì—­</button>
        <button class="btn btn-outline" onclick="renderPreview()">ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn btn-primary" onclick="copyCode()">HTML ë³µì‚¬</button>
        <button class="btn btn-outline" onclick="exportPDF()">PDF</button>
        <button class="btn btn-outline" onclick="exportImage()">IMG</button>
        <div class="autosave-indicator">
            <div class="autosave-dot"></div>
            <span id="lastSaveTime">ì €ì¥ëœ ì  ì—†ìŒ</span>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â• ë¯¸ë¦¬ë³´ê¸° â•â•â•â•â•â•â• -->
<div class="preview-panel">
    <div class="preview-controls">
        <div class="zoom-control">
            <button class="zoom-btn" onclick="zoomPreview(-0.1)">âˆ’</button>
            <span class="zoom-value" id="zoomValue">100%</span>
            <button class="zoom-btn" onclick="zoomPreview(0.1)">+</button>
        </div>
        <label style="margin-left: 12px;">
            <input type="checkbox" id="livePreview" checked onchange="toggleLivePreview()"> ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°
        </label>
    </div>
    <div id="preview-container"></div>
</div>

<!-- â•â•â•â•â•â•â• í™•ëŒ€ í¸ì§‘ ëª¨ë‹¬ â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="bigEditorModal">
    <div class="modal-box">
        <div class="modal-header">
            <div style="display:flex; align-items:center; gap:12px;">
                <span style="color:#9090c0; font-size:13px; font-weight:600;">ë³¸ë¬¸ í¸ì§‘</span>
                <div id="bigEditorShortcuts"></div>
            </div>
            <button onclick="closeBigEditor()" style="background:none; border:none; color:#606080; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <textarea id="bigEditorTextarea" style="flex:1; margin:16px; padding:20px; background:#0a0a10; border:1px solid #1e1e28; border-radius:8px; color:#c0c0d0; font-size:14px; line-height:1.8; resize:none;"></textarea>
        <div class="modal-footer">
            <button onclick="closeBigEditor()" class="btn btn-outline" style="margin-right:8px;">ì·¨ì†Œ</button>
            <button onclick="saveBigEditor()" class="btn btn-primary">ì ìš©</button>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â• íƒ€ì„ë¼ì¸ ë·° â•â•â•â•â•â•â• -->
<div id="timelineView" class="timeline-view" style="display: none;">
    <div class="timeline-close" onclick="toggleTimeline()">Ã—</div>
    <div class="timeline-header">Timeline</div>
    <div id="timelineContent"></div>
</div>

<!-- â•â•â•â•â•â•â• ê²€ìƒ‰&ì¹˜í™˜ ëª¨ë‹¬ â•â•â•â•â•â•â• -->
<div id="searchModal" class="search-modal">
    <div class="search-modal-content">
        <div class="search-modal-header">
            <div class="search-modal-title">ğŸ” ê²€ìƒ‰ & ì¹˜í™˜</div>
            <div class="search-modal-close" onclick="closeSearchModal()">Ã—</div>
        </div>
        <div class="form-group">
            <label>ê²€ìƒ‰ì–´</label>
            <input type="text" id="searchInput" placeholder="ì°¾ì„ í…ìŠ¤íŠ¸ ì…ë ¥...">
        </div>
        <div class="form-group">
            <label>ì¹˜í™˜í•  í…ìŠ¤íŠ¸ (ì„ íƒì‚¬í•­)</label>
            <input type="text" id="replaceInput" placeholder="ë°”ê¿€ í…ìŠ¤íŠ¸ ì…ë ¥...">
        </div>
        <div style="display: flex; gap: 8px; margin-top: 12px;">
            <button class="btn btn-primary" onclick="performSearch()">ê²€ìƒ‰</button>
            <button class="btn btn-outline" onclick="performReplace()">ì¹˜í™˜</button>
            <button class="btn btn-outline" onclick="performReplaceAll()">ì „ì²´ ì¹˜í™˜</button>
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>
</div>

<!-- â•â•â•â•â•â•â• ìë™ì €ì¥ ìŠ¬ë¡¯ ëª¨ë‹¬ â•â•â•â•â•â•â• -->
<div id="autoSaveModal" class="search-modal">
    <div class="search-modal-content">
        <div class="search-modal-header">
            <div class="search-modal-title">ğŸ’¾ ìë™ ì €ì¥ ë‚´ì—­</div>
            <div class="search-modal-close" onclick="closeAutoSaveModal()">Ã—</div>
        </div>
        <div class="slot-list" id="autoSaveSlots"></div>
    </div>
</div>


<!-- ë‹¨ì¶•í‚¤ íŒíŠ¸ -->
<div id="shortcutHint" class="shortcut-hint">
    <kbd>Ctrl</kbd>+<kbd>S</kbd> ì €ì¥ | 
    <kbd>Ctrl</kbd>+<kbd>F</kbd> ê²€ìƒ‰ |
    <kbd>Ctrl</kbd>+<kbd>T</kbd> íƒ€ì„ë¼ì¸
</div>

<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ì „ì—­ ìƒíƒœ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let chapterCount = 0;
    let currentTheme = 'obsidian';
    let coverLayout = 'default';
    let selectedGradient = 0;
    let currentEditingTextarea = null;

    // ì¸ë¬¼ ë°°ì—´
    let characters = [];
    let charIdCounter = 0;

    // ìƒˆ ê¸°ëŠ¥ ë³€ìˆ˜
    let previewZoom = 1.0;
    let livePreviewEnabled = true;
    let autoSaveInterval = null;
    let autoSaveSlots = [];
    const MAX_AUTOSAVE_SLOTS = 3;

    // ê·¸ë¼ë°ì´ì…˜ í”„ë¦¬ì…‹
    const gradientPresets = [
        { c1: '#0a0a1a', c2: '#1a1a3a', angle: 135 },
        { c1: '#1a0a1a', c2: '#3a1a2a', angle: 135 },
        { c1: '#0a1a1a', c2: '#1a3a3a', angle: 135 },
        { c1: '#1a1a0a', c2: '#3a3a1a', angle: 135 },
        { c1: '#f0e8e0', c2: '#e0d0c0', angle: 135 },
        { c1: '#e8e0f0', c2: '#d0c0e0', angle: 135 },
    ];

    const defaultColors = ['#E8A0B0','#90C0E0','#A0D0A0','#E0C080','#C0A0E0','#80D0D0','#E0A080','#A0A0E0'];

    // â”€â”€ í…Œë§ˆ â”€â”€
    const themes = {
        obsidian: {
            wrapBg:'#08080c', cardBg:'#0c0c12', contentBg:'#0a0a0e', headerBg:'#0e0e14',
            text:'#d8d8e8', textSoft:'#a0a0b8', textMuted:'#606078',
            accent:'#8080c0', accentGlow:'rgba(128,128,192,0.15)',
            border:'#1a1a28', divider:'#18182a',
            coverTextShadow:'0 2px 16px rgba(0,0,0,0.9)',
            stripeBg:'repeating-linear-gradient(135deg,transparent,transparent 1px,rgba(128,128,192,0.03) 1px,rgba(128,128,192,0.03) 2px)',
        },
        vintage: {
            wrapBg:'#f0ebe0', cardBg:'#f8f5ee', contentBg:'#fffdf8', headerBg:'#f4efe4',
            text:'#2a2620', textSoft:'#5a5448', textMuted:'#8a8478',
            accent:'#8a7a60', accentGlow:'rgba(138,122,96,0.1)',
            border:'#e0d8c8', divider:'#e8e0d0',
            coverTextShadow:'0 2px 12px rgba(0,0,0,0.2)',
            stripeBg:'repeating-linear-gradient(135deg,transparent,transparent 1px,rgba(138,122,96,0.04) 1px,rgba(138,122,96,0.04) 2px)',
        },
        cherry: {
            wrapBg:'#fff5f8', cardBg:'#fffafc', contentBg:'#ffffff', headerBg:'#fff8fa',
            text:'#3a2830', textSoft:'#6a4858', textMuted:'#a08090',
            accent:'#d88aa0', accentGlow:'rgba(216,138,160,0.12)',
            border:'#f8d8e0', divider:'#ffe8f0',
            coverTextShadow:'0 2px 12px rgba(0,0,0,0.15)',
            stripeBg:'repeating-linear-gradient(135deg,transparent,transparent 1px,rgba(216,138,160,0.05) 1px,rgba(216,138,160,0.05) 2px)',
        },
        pure: {
            wrapBg:'#f8f8f8', cardBg:'#ffffff', contentBg:'#fafafa', headerBg:'#f5f5f5',
            text:'#1a1a1a', textSoft:'#4a4a4a', textMuted:'#888888',
            accent:'#3a3a3a', accentGlow:'rgba(0,0,0,0.04)',
            border:'#e0e0e0', divider:'#eeeeee',
            coverTextShadow:'0 2px 12px rgba(0,0,0,0.12)',
            stripeBg:'repeating-linear-gradient(135deg,transparent,transparent 1px,rgba(0,0,0,0.02) 1px,rgba(0,0,0,0.02) 2px)',
        },
        violet: {
            wrapBg:'#12101a', cardBg:'#18141f', contentBg:'#140f1a', headerBg:'#1a1520',
            text:'#e0d8f0', textSoft:'#b8a8d0', textMuted:'#706088',
            accent:'#a880d0', accentGlow:'rgba(168,128,208,0.12)',
            border:'#2a2038', divider:'#241a30',
            coverTextShadow:'0 2px 16px rgba(0,0,0,0.9)',
            stripeBg:'repeating-linear-gradient(135deg,transparent,transparent 1px,rgba(168,128,208,0.03) 1px,rgba(168,128,208,0.03) 2px)',
        }
    };

    const customColorKeys = ['wrapBg','cardBg','contentBg','headerBg','text','textSoft','textMuted','accent','border','divider'];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  íƒ­ ì „í™˜
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function switchTab(tabName, btn) {
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(tb => tb.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
        btn.classList.add('active');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  í…Œë§ˆ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function setTheme(name, el) {
        currentTheme = name;
        document.querySelectorAll('.theme-opt').forEach(o => o.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('useCustomTheme').checked = false;
        document.getElementById('customThemeEditor').style.display = 'none';
        document.querySelectorAll('.theme-opt').forEach(o => o.style.opacity = '1');
        renderPreview();
    }

    function toggleCustomTheme() {
        const checked = document.getElementById('useCustomTheme').checked;
        document.getElementById('customThemeEditor').style.display = checked ? 'block' : 'none';
        document.querySelectorAll('.theme-opt').forEach(o => o.style.opacity = checked ? '0.4' : '1');
        renderPreview();
    }

    function getActiveTheme() {
        if (document.getElementById('useCustomTheme').checked) return getCustomTheme();
        return themes[currentTheme];
    }

    function getCustomTheme() {
        const ct = {};
        customColorKeys.forEach(key => { ct[key] = document.getElementById('ct_' + key).value; });
        const a = ct.accent;
        const r = parseInt(a.slice(1,3),16), g = parseInt(a.slice(3,5),16), b = parseInt(a.slice(5,7),16);
        ct.accentGlow = `rgba(${r},${g},${b},0.12)`;
        ct.coverTextShadow = isLightColor(ct.wrapBg) ? '0 2px 12px rgba(0,0,0,0.15)' : '0 2px 16px rgba(0,0,0,0.9)';
        ct.stripeBg = `repeating-linear-gradient(135deg,transparent,transparent 1px,rgba(${r},${g},${b},0.03) 1px,rgba(${r},${g},${b},0.03) 2px)`;
        return ct;
    }

    function isLightColor(hex) {
        const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
        return (r*299+g*587+b*114)/1000 > 128;
    }

    function syncColorText(picker) {
        picker.parentElement.querySelector('input[type="text"]').value = picker.value;
        renderPreview();
    }
    function syncColorPicker(textInput) {
        const picker = document.getElementById(textInput.dataset.for);
        if (/^#[0-9a-fA-F]{6}$/.test(textInput.value)) picker.value = textInput.value;
        renderPreview();
    }
    function loadPresetIntoCustom() {
        const preset = themes[currentTheme];
        customColorKeys.forEach(key => {
            const p = document.getElementById('ct_'+key);
            p.value = preset[key];
            p.parentElement.querySelector('input[type="text"]').value = preset[key];
        });
        renderPreview();
    }
    function saveCustomTheme() {
        const data = {};
        customColorKeys.forEach(key => { data[key] = document.getElementById('ct_'+key).value; });
        try { localStorage.setItem('archiveLog_customTheme', JSON.stringify(data)); alert('âœ… ì €ì¥ë¨!'); } catch(e) { alert('âš ï¸ ì‹¤íŒ¨'); }
    }
    function loadSavedCustomTheme() {
        try {
            const saved = localStorage.getItem('archiveLog_customTheme');
            if (saved) {
                const data = JSON.parse(saved);
                customColorKeys.forEach(key => {
                    if (data[key]) {
                        const p = document.getElementById('ct_'+key);
                        p.value = data[key]; 
                        p.parentElement.querySelector('input[type="text"]').value = data[key];
                    }
                });
            }
        } catch(e) {}
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ì»¤ë²„ ë ˆì´ì•„ì›ƒ & ê·¸ë¼ë°ì´ì…˜
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function setCoverLayout(layout, el) {
        coverLayout = layout;
        document.querySelectorAll('.layout-opt').forEach(o => o.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('coverImgSection').style.display = (layout === 'noimage') ? 'none' : 'block';
        document.getElementById('gradientSection').style.display = (layout === 'noimage') ? 'block' : 'none';
        renderPreview();
    }

    function setGradient(idx, el) {
        selectedGradient = idx;
        const g = gradientPresets[idx];
        document.getElementById('gradColor1').value = g.c1;
        document.getElementById('gradColor2').value = g.c2;
        document.getElementById('gradAngle').value = g.angle;
        document.querySelectorAll('.gradient-opt').forEach(o => o.classList.remove('active'));
        el.classList.add('active');
        renderPreview();
    }

    function getGradientCSS() {
        const c1 = document.getElementById('gradColor1').value;
        const c2 = document.getElementById('gradColor2').value;
        const angle = document.getElementById('gradAngle').value;
        return `linear-gradient(${angle}deg, ${c1}, ${c2})`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  í°íŠ¸
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function onFontChange() {
        const sel = document.getElementById('fontSelect').value;
        document.getElementById('customFontGroup').style.display = (sel === 'custom') ? 'block' : 'none';
    }

    function getFont() {
        const sel = document.getElementById('fontSelect').value;
        if (sel === 'custom') return document.getElementById('customFontName').value || "'Noto Serif KR', serif";
        return sel;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ì¸ë¬¼ ê´€ë¦¬
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function addCharacter(name, color, img, desc) {
        charIdCounter++;
        const id = charIdCounter;
        const c = {
            id,
            name: name || `ì¸ë¬¼ ${id}`,
            color: color || defaultColors[(id - 1) % defaultColors.length],
            img: img || '',
            desc: desc || ''
        };
        characters.push(c);
        renderCharCards();
        renderPreview();
        updateShortcutButtons();
    }

    function removeCharacter(id) {
        characters = characters.filter(c => c.id !== id);
        renderCharCards();
        renderPreview();
        updateShortcutButtons();
    }

    function updateCharField(id, field, value) {
        const c = characters.find(ch => ch.id === id);
        if (c) c[field] = value;
        renderPreview();
        if (field === 'name') updateShortcutButtons();
    }

    function renderCharCards() {
        const container = document.getElementById('chars-container');
        container.innerHTML = '';
        characters.forEach((c, idx) => {
            container.insertAdjacentHTML('beforeend', `
                <div class="char-card" id="char-${c.id}">
                    <div class="char-card-header">
                        <span style="font-size:10px; font-weight:700; color:${c.color};">ã…‹${idx+1}</span>
                        <input type="text" value="${c.name}" oninput="updateCharField(${c.id}, 'name', this.value)" style="flex:1;">
                        <input type="color" value="${c.color}" oninput="updateCharField(${c.id}, 'color', this.value)" style="width:32px; height:26px; padding:1px;">
                        <button class="btn btn-danger btn-sm" onclick="removeCharacter(${c.id})">ì‚­ì œ</button>
                    </div>
                    <div class="form-group" style="margin:0 0 6px;"><label>ì´ë¯¸ì§€ URL</label><input type="text" value="${c.img}" oninput="updateCharField(${c.id}, 'img', this.value)" placeholder="//ac..."></div>
                    <div class="form-group" style="margin:0;"><label>ì†Œê°œ</label><textarea oninput="updateCharField(${c.id}, 'desc', this.value)" style="min-height:36px;">${c.desc}</textarea></div>
                </div>
            `);
        });
        // ê´€ê³„ë„ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
        document.getElementById('relationSection').style.display = (characters.length === 2) ? 'block' : 'none';
    }

    // ëŒ€ì‚¬ ë‹¨ì¶•í‚¤ ë²„íŠ¼ ë™ì  ìƒì„±
    function getShortcutButtonsHTML(logId, isBig) {
        const fn = isBig ? 'insertTagBig' : 'insertTag';
        const idArg = isBig ? '' : `'${logId}', `;
        let html = '';
        characters.forEach((c, idx) => {
            const tag = `ã…‹${idx + 1}: `;
            html += `<span class="btn-shortcut" onclick="${fn}(${idArg}'${tag}')" style="border-left:2px solid ${c.color};">${c.name.slice(0, 4)}</span>`;
        });
        html += `<span class="btn-shortcut" onclick="${fn}(${idArg}'ã……: ')">ì†ë§ˆìŒ</span>`;
        html += `<span class="btn-shortcut" onclick="${fn}(${idArg}'ã„·: ')">ë…ë°±</span>`;
        return html;
    }

    function updateShortcutButtons() {
        // ëª¨ë“  ë¡œê·¸ ì—”íŠ¸ë¦¬ì˜ ë‹¨ì¶•í‚¤ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.log-entry').forEach(entry => {
            const shortcuts = entry.querySelector('.log-shortcuts');
            if (shortcuts) shortcuts.innerHTML = getShortcutButtonsHTML(entry.id, false);
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ì±•í„° & ë¡œê·¸
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function addChapter() {
        chapterCount++;
        const id = `chap-${chapterCount}`;
        const html = `
            <div class="section-box chapter-box" id="${id}" style="margin-bottom:8px;">
                <div class="section-title" style="justify-content:space-between;">
                    <span>Chapter ${chapterCount}</span>
                    <div>
                        <button class="btn btn-sm btn-outline" onclick="moveChapter('${id}', -1)">â–²</button>
                        <button class="btn btn-sm btn-outline" onclick="moveChapter('${id}', 1)">â–¼</button>
                        <button class="btn btn-sm btn-danger" onclick="document.getElementById('${id}').remove(); renderPreview();">ì‚­ì œ</button>
                    </div>
                </div>
                <div class="form-group"><label>ì œëª©</label><input type="text" class="chap-title" value="Chapter Title" oninput="renderPreview()"></div>
                <div class="form-group"><label>ì •ë³´</label><input type="text" class="chap-info" value="Scene 01" oninput="renderPreview()"></div>
                <div id="logs-${id}"></div>
                <button class="btn btn-outline" style="width:100%; margin-top:6px; font-size:9px; padding:6px;" onclick="addLog('${id}')">+ ëŒ€ì‚¬</button>
            </div>`;
        document.getElementById('chapters-container').insertAdjacentHTML('beforeend', html);
        addLog(id);
    }

    function addLog(chapId) {
        const logId = `log-${Date.now()}-${Math.random().toString(36).slice(2,6)}`;
        const html = `
            <div class="log-entry" id="${logId}">
                <div style="margin-bottom:4px; display:flex; justify-content:space-between; align-items:center;">
                    <div class="log-shortcuts">${getShortcutButtonsHTML(logId, false)}</div>
                    <div>
                        <button class="btn btn-sm btn-outline" onclick="moveLog('${logId}', -1)">â–²</button>
                        <button class="btn btn-sm btn-outline" onclick="moveLog('${logId}', 1)">â–¼</button>
                        <button style="border:none; background:none; cursor:pointer; color:#7070a0; font-size:11px; margin:0 4px;" onclick="openBigEditor('${logId}')">í™•ëŒ€</button>
                        <button style="border:none; background:none; cursor:pointer; color:#505068; font-size:14px;" onclick="document.getElementById('${logId}').remove(); renderPreview();">Ã—</button>
                    </div>
                </div>
                <textarea class="log-content" oninput="renderPreview()" placeholder="ã…‹1: ìºë¦­í„°1 ëŒ€ì‚¬ / ã……: ì†ë§ˆìŒ / ã„·: ë…ë°± / ---: ì¥ë©´ì „í™˜"></textarea>
            </div>`;
        document.getElementById(`logs-${chapId}`).insertAdjacentHTML('beforeend', html);
    }

    function moveChapter(id, dir) {
        const el = document.getElementById(id);
        const container = document.getElementById('chapters-container');
        if (dir === -1 && el.previousElementSibling) container.insertBefore(el, el.previousElementSibling);
        else if (dir === 1 && el.nextElementSibling) container.insertBefore(el.nextElementSibling, el);
        renderPreview();
    }

    function moveLog(id, dir) {
        const el = document.getElementById(id);
        const parent = el.parentElement;
        if (dir === -1 && el.previousElementSibling) parent.insertBefore(el, el.previousElementSibling);
        else if (dir === 1 && el.nextElementSibling) parent.insertBefore(el.nextElementSibling, el);
        renderPreview();
    }

    function insertTag(logId, tag) {
        const el = document.getElementById(logId).querySelector('textarea');
        const start = el.selectionStart;
        const nl = start > 0 && el.value[start-1] !== '\n' ? '\n' : '';
        el.value = el.value.substring(0, start) + nl + tag + el.value.substring(el.selectionEnd);
        el.selectionStart = el.selectionEnd = start + nl.length + tag.length;
        el.focus(); renderPreview();
    }
    function insertTagBig(tag) {
        const el = document.getElementById('bigEditorTextarea');
        const start = el.selectionStart;
        const nl = start > 0 && el.value[start-1] !== '\n' ? '\n' : '';
        el.value = el.value.substring(0, start) + nl + tag + el.value.substring(el.selectionEnd);
        el.selectionStart = el.selectionEnd = start + nl.length + tag.length;
        el.focus();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ë§ˆí¬ë‹¤ìš´ & ìë™ë³€í™˜
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function parseMarkdown(text, theme) {
        // ìë™ ë³€í™˜
        if (document.getElementById('autoEllipsis').checked) text = text.replace(/\.\.\./g, 'â‹¯');
        if (document.getElementById('autoEmdash').checked) text = text.replace(/--/g, 'â€”');
        // ê°ì£¼ ë§ˆì»¤ [^n] â†’ ìœ„ì²¨ì ë§í¬
        text = text.replace(/\[\^(\d+)\]/g, '<sup style="font-size:9px; color:' + theme.accent + '; cursor:pointer;">[$1]</sup>');
        // ë³¼ë“œ
        text = text.replace(/\*\*(.+?)\*\*/g, `<span style="font-weight:700; background:${theme.accent}30; padding:1px 5px; border-radius:3px;">$1</span>`);
        // ì´íƒ¤ë¦­
        text = text.replace(/\*(.+?)\*/g, '<em style="font-style:italic;">$1</em>');
        // í—¤ë”© (ì¤„ ë‹¨ìœ„)
        text = text.replace(/^### (.+)$/gm, `<div style="font-size:16px; font-weight:700; margin:20px 0 10px; color:${theme.text};">$1</div>`);
        text = text.replace(/^## (.+)$/gm, `<div style="font-size:20px; font-weight:700; margin:24px 0 12px; color:${theme.text};">$1</div>`);
        text = text.replace(/^# (.+)$/gm, `<div style="font-size:26px; font-weight:700; margin:28px 0 14px; color:${theme.text};">$1</div>`);
        return text;
    }

    function extractQuoted(text) {
        const m = text.match(/[\u201C\u201D]([^\u201C\u201D]+)[\u201C\u201D]/) || text.match(/"([^"]+)"/);
        return m ? m[1] : text;
    }

    // ê°ì£¼ ìˆ˜ì§‘ (ë³¸ë¬¸ ì „ì²´ì—ì„œ)
    function collectFootnotes(allText) {
        const notes = {};
        const regex = /^\[\^(\d+)\]:\s*(.+)$/gm;
        let m;
        while ((m = regex.exec(allText)) !== null) {
            notes[m[1]] = m[2];
        }
        return notes;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  HTML ìƒì„±
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function generateFullHTML() {
        const t = getActiveTheme();
        const font = getFont();
        const coverTitle = document.getElementById('coverTitle').value;
        const coverSubtitle = document.getElementById('coverSubtitle').value;
        const coverImg = document.getElementById('coverImg').value;
        const dateText = document.getElementById('dateText').value;
        const tagText = document.getElementById('tagText').value;
        const showCharIntro = document.getElementById('showCharIntro').checked;
        const useCollapse = document.getElementById('useCollapse').checked;
        const commentText = document.getElementById('commentText').value;
        const hashTags = document.getElementById('hashTags').value;
        const authorName = document.getElementById('authorName').value;
        const showNote = document.getElementById('showNote').checked;

        // â”€â”€ ê°ì£¼ ìˆ˜ì§‘ â”€â”€
        let allRawText = '';
        document.querySelectorAll('.log-content').forEach(el => { allRawText += el.value + '\n'; });
        const footnotes = collectFootnotes(allRawText);

        // â”€â”€ í•´ì‹œíƒœê·¸ â”€â”€
        let tagsHTML = '';
        if (hashTags.trim()) {
            const tags = hashTags.split(',').map(t => t.trim().replace(/^#/,'')).filter(t => t);
            if (tags.length) {
                tagsHTML = '<div style="margin-top:24px;">' + tags.map(tag =>
                    `<span style="display:inline-block; padding:4px 12px; margin:3px; border:1px solid rgba(255,255,255,0.25); border-radius:12px; font-size:10px; color:rgba(255,255,255,0.75); letter-spacing:0.03em;">${tag}</span>`
                ).join('') + '</div>';
            }
        }

        // â”€â”€ í‘œì§€ â”€â”€
        let coverHTML = '';
        const coverTextBlock = `
            <div style="color:#ffffff; text-shadow:0 1px 8px rgba(0,0,0,0.7);">
                <div style="display:inline-block; font-size:10px; letter-spacing:0.4em; text-transform:uppercase; border:1px solid rgb(255,255,255); padding:4px 18px; margin-bottom:28px; color:rgb(255,255,255);">${tagText}</div>
                <div style="font-size:40px; font-weight:300; letter-spacing:0.1em; line-height:1.3; margin-bottom:20px; text-shadow:0 2px 20px rgba(0,0,0,0.95),0 0 60px rgba(0,0,0,0.7),0 0 4px rgba(0,0,0,0.9);">${coverTitle}</div>
                <div style="font-size:12px; letter-spacing:0.25em; color:rgba(255,255,255,0.5); margin-bottom:16px;">âœ§</div>
                <div style="font-size:13px; letter-spacing:0.2em; opacity:0.85; margin-bottom:8px;">${coverSubtitle}</div>
                <div style="font-size:10px; font-family:'Courier New',Courier,monospace; opacity:0.5;">${dateText}</div>
                ${tagsHTML}
            </div>`;

        if (coverLayout === 'default') {
            coverHTML = `
            <div style="width:100%; height:480px; display:table; background:url('https:${coverImg}') 50% 50%/cover no-repeat;">
                <div style="display:table-cell; vertical-align:bottom; text-align:center; padding:40px 28px 48px; background:linear-gradient(to top,rgba(0,0,0,0.85),rgba(0,0,0,0.4),rgba(0,0,0,0.1),transparent);">
                    ${coverTextBlock}
                </div>
            </div>`;
        } else if (coverLayout === 'noimage') {
            const grad = getGradientCSS();
            const isLight = isLightColor(document.getElementById('gradColor1').value);
            const textColor = isLight ? '#1a1a1a' : '#ffffff';
            const borderColor = isLight ? 'rgba(0,0,0,0.2)' : 'rgba(255,255,255,0.25)';
            const subColor = isLight ? 'rgba(0,0,0,0.4)' : 'rgba(255,255,255,0.5)';
            coverHTML = `
            <div style="width:100%; height:480px; display:table; background:${grad};">
                <div style="display:table-cell; vertical-align:middle; text-align:center; padding:40px 28px;">
                    <div style="color:${textColor};">
                        <div style="display:inline-block; font-size:10px; letter-spacing:0.4em; text-transform:uppercase; border:1px solid ${borderColor}; padding:4px 18px; margin-bottom:28px;">${tagText}</div>
                        <div style="font-size:40px; font-weight:300; letter-spacing:0.1em; line-height:1.3; margin-bottom:20px;">${coverTitle}</div>
                        <div style="font-size:12px; letter-spacing:0.25em; color:${subColor}; margin-bottom:16px;">âœ§</div>
                        <div style="font-size:13px; letter-spacing:0.2em; opacity:0.85; margin-bottom:8px;">${coverSubtitle}</div>
                        <div style="font-size:10px; font-family:'Courier New',Courier,monospace; opacity:0.5;">${dateText}</div>
                        ${tagsHTML.replace(/rgba\(255,255,255/g, borderColor.includes('0,0,0') ? 'rgba(0,0,0' : 'rgba(255,255,255')}
                    </div>
                </div>
            </div>`;
        } else if (coverLayout === 'split') {
            coverHTML = `
            <div style="display:table; width:100%; min-height:400px;">
                <div style="display:table-cell; width:50%; vertical-align:top; background:url('https:${coverImg}') 50% 50%/cover no-repeat;"></div>
                <div style="display:table-cell; width:50%; vertical-align:middle; text-align:center; padding:40px 28px; background:${t.headerBg};">
                    <div style="color:${t.text};">
                        <div style="display:inline-block; font-size:10px; letter-spacing:0.4em; text-transform:uppercase; border:1px solid ${t.border}; padding:4px 18px; margin-bottom:28px; color:${t.textMuted};">${tagText}</div>
                        <div style="font-size:32px; font-weight:300; letter-spacing:0.1em; line-height:1.3; margin-bottom:20px;">${coverTitle}</div>
                        <div style="font-size:12px; letter-spacing:0.25em; color:${t.textMuted}; margin-bottom:16px;">âœ§</div>
                        <div style="font-size:13px; letter-spacing:0.2em; color:${t.textSoft}; margin-bottom:8px;">${coverSubtitle}</div>
                        <div style="font-size:10px; font-family:'Courier New',Courier,monospace; color:${t.textMuted};">${dateText}</div>
                    </div>
                </div>
            </div>`;
        }

        // â”€â”€ ì¸ë¬¼ ì†Œê°œ â”€â”€
        let charIntroHTML = '';
        if (showCharIntro && characters.length > 0) {
            if (characters.length === 2) {
                // 2ì¸ ê´€ê³„ë„
                const a = characters[0], b = characters[1];
                const aImgStyle = a.img ? `background:url('https:${a.img}') center/cover no-repeat;` : `background:${a.color}30;`;
                const bImgStyle = b.img ? `background:url('https:${b.img}') center/cover no-repeat;` : `background:${b.color}30;`;
                const r12 = document.getElementById('relation12').value;
                const r21 = document.getElementById('relation21').value;
                charIntroHTML = `
                <div style="padding:36px 24px; background:${t.contentBg}; border-top:1px solid ${t.divider};">
                    <div style="text-align:center; margin-bottom:32px;">
                        <span style="font-size:9px; font-weight:600; letter-spacing:0.3em; color:${t.textMuted}; text-transform:uppercase;">Relationship</span>
                    </div>
                    <div style="display:table; width:100%;">
                        <div style="display:table-row;">
                            <div style="display:table-cell; width:38%; vertical-align:top; text-align:center; padding:20px 12px 16px; background:${t.accentGlow}; border-radius:12px;">
                                <div style="width:84px; height:84px; ${aImgStyle} border-radius:50%; margin:0 auto 14px; border:2px solid ${a.color}; box-shadow:0 0 0 4px ${a.color}20;"></div>
                                <div style="font-size:15px; font-weight:600; color:${a.color}; margin-bottom:4px;">${a.name}</div>
                                <div style="width:24px; height:1px; background:${a.color}; margin:0 auto 10px;"></div>
                                <div style="font-size:11px; line-height:1.7; color:${t.textSoft};">${a.desc.replace(/\n/g,'<br>')}</div>
                            </div>
                            <div style="display:table-cell; width:24%; vertical-align:middle; text-align:center; padding:0 4px;">
                                <div style="padding:12px 0;">
                                    <div style="font-size:14px; font-weight:700; color:${a.color}; margin-bottom:4px;">âŸ¶</div>
                                    <div style="font-size:10px; color:${t.textMuted}; font-style:italic; line-height:1.6; padding:8px 4px; border-top:2px solid ${a.color}50; border-bottom:1px dashed ${t.divider};">ã€Œ${r12}ã€</div>
                                    <div style="margin:10px 0; font-size:11px; color:${t.accent};">âœ¦</div>
                                    <div style="font-size:10px; color:${t.textMuted}; font-style:italic; line-height:1.6; padding:8px 4px; border-top:1px dashed ${t.divider}; border-bottom:2px solid ${b.color}50;">ã€Œ${r21}ã€</div>
                                    <div style="font-size:14px; font-weight:700; color:${b.color}; margin-top:4px;">âŸµ</div>
                                </div>
                            </div>
                            <div style="display:table-cell; width:38%; vertical-align:top; text-align:center; padding:20px 12px 16px; background:${t.accentGlow}; border-radius:12px;">
                                <div style="width:84px; height:84px; ${bImgStyle} border-radius:50%; margin:0 auto 14px; border:2px solid ${b.color}; box-shadow:0 0 0 4px ${b.color}20;"></div>
                                <div style="font-size:15px; font-weight:600; color:${b.color}; margin-bottom:4px;">${b.name}</div>
                                <div style="width:24px; height:1px; background:${b.color}; margin:0 auto 10px;"></div>
                                <div style="font-size:11px; line-height:1.7; color:${t.textSoft};">${b.desc.replace(/\n/g,'<br>')}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
            } else {
                // 3ì¸ ì´ìƒ ì¹´ë“œ ë‚˜ì—´
                let cardsHTML = characters.map(c => {
                    const imgStyle = c.img ? `background:url('https:${c.img}') center/cover no-repeat;` : `background:${c.color}30;`;
                    return `
                    <div style="display:inline-block; width:${Math.min(180, Math.floor(600/characters.length))}px; vertical-align:top; text-align:center; padding:20px 12px 16px; background:${t.accentGlow}; border-radius:12px; margin:6px;">
                        <div style="width:72px; height:72px; ${imgStyle} border-radius:50%; margin:0 auto 12px; border:2px solid ${c.color}; box-shadow:0 0 0 4px ${c.color}20;"></div>
                        <div style="font-size:14px; font-weight:600; color:${c.color}; margin-bottom:4px;">${c.name}</div>
                        <div style="width:20px; height:1px; background:${c.color}; margin:0 auto 8px;"></div>
                        <div style="font-size:10px; line-height:1.7; color:${t.textSoft};">${c.desc.replace(/\n/g,'<br>')}</div>
                    </div>`;
                }).join('');
                charIntroHTML = `
                <div style="padding:36px 24px; background:${t.contentBg}; border-top:1px solid ${t.divider}; text-align:center;">
                    <div style="margin-bottom:24px;">
                        <span style="font-size:9px; font-weight:600; letter-spacing:0.3em; color:${t.textMuted}; text-transform:uppercase;">Characters</span>
                    </div>
                    ${cardsHTML}
                </div>`;
            }
        }

        // â”€â”€ ì±•í„° â”€â”€
        let chaptersHTML = '';
        document.querySelectorAll('.chapter-box').forEach((chap, idx) => {
            const title = chap.querySelector('.chap-title').value;
            const info = chap.querySelector('.chap-info').value;
            let logsHTML = '';
            
            chap.querySelectorAll('.log-content').forEach(logEl => {
                logEl.value.split('\n').forEach(line => {
                    if (!line.trim()) return;
                    let content = line.trim();
                    
                    // ê°ì£¼ ì •ì˜ ì¤„ì€ ê±´ë„ˆë›°ê¸°
                    if (/^\[\^\d+\]:/.test(content)) return;

                    // ì¥ë©´ êµ¬ë¶„ì„ 
                    if (content === '---' || content === '***') {
                        logsHTML += `<div style="margin:40px auto; text-align:center;"><span style="font-size:11px; letter-spacing:1em; color:${t.textMuted};">Â· Â· Â·</span></div>`;
                        return;
                    }

                    // í—¤ë”© ì „ìš© ì¤„
                    if (/^#{1,3} /.test(content)) {
                        logsHTML += `<div style="padding:0 8px;">${parseMarkdown(content, t)}</div>`;
                        return;
                    }

                    // ìºë¦­í„° ëŒ€ì‚¬ (ã…‹1: ~ ã…‹N:)
                    const charMatch = content.match(/^ã…‹(\d+):\s*/);
                    if (charMatch) {
                        const charIdx = parseInt(charMatch[1]) - 1;
                        const c = characters[charIdx];
                        if (c) {
                            let txt = content.replace(/^ã…‹\d+:\s*/, '').trim();
                            txt = extractQuoted(txt);
                            const isEven = charIdx % 2 === 1;
                            if (isEven) {
                                logsHTML += `
                                <div style="margin-bottom:24px; text-align:right;">
                                    <div style="margin-bottom:8px;">
                                        <span style="font-size:11px; font-weight:600; color:${c.color}; vertical-align:middle;">${c.name}</span>
                                        <span style="font-size:6px; color:${c.color}; margin-left:6px; vertical-align:middle;">â—</span>
                                    </div>
                                    <div style="display:inline-block; max-width:82%; padding:16px 22px; background-color:${c.color}18; border-right:3px solid ${c.color}; border-radius:12px 0 0 12px; font-size:14.5px; line-height:1.9; color:${t.text};">${parseMarkdown(txt, t)}</div>
                                </div>`;
                            } else {
                                logsHTML += `
                                <div style="margin-bottom:24px;">
                                    <div style="margin-bottom:8px;">
                                        <span style="font-size:6px; color:${c.color}; margin-right:6px; vertical-align:middle;">â—</span>
                                        <span style="font-size:11px; font-weight:600; color:${c.color}; vertical-align:middle;">${c.name}</span>
                                    </div>
                                    <div style="display:inline-block; max-width:82%; padding:16px 22px; background-color:${c.color}18; border-left:3px solid ${c.color}; border-radius:0 12px 12px 0; font-size:14.5px; line-height:1.9; color:${t.text};">${parseMarkdown(txt, t)}</div>
                                </div>`;
                            }
                        }
                        return;
                    }

                    // ì†ë§ˆìŒ
                    if (content.startsWith('ã……:')) {
                        let txt = content.replace('ã……:', '').trim();
                        logsHTML += `
                        <div style="margin:40px 16px; padding:20px 24px; text-align:center; border-top:1px solid ${t.divider}; border-bottom:1px solid ${t.divider};">
                            <span style="font-size:14px; line-height:2.2; color:${t.textMuted}; letter-spacing:0.04em;">${parseMarkdown(txt, t)}</span>
                        </div>`;
                        return;
                    }

                    // ë…ë°±
                    if (content.startsWith('ã„·:')) {
                        let txt = content.replace('ã„·:', '').trim();
                        logsHTML += `
                        <div style="margin:24px 20px; text-align:center;">
                            <span style="display:inline-block; padding:10px 24px; background:${t.accentGlow}; border:1px dashed ${t.divider}; border-radius:4px; font-size:14px; color:${t.textMuted}; font-style:italic; letter-spacing:0.04em;">${parseMarkdown(txt, t)}</span>
                        </div>`;
                        return;
                    }

                    // ì¼ë°˜ ì§€ë¬¸
                    logsHTML += `
                    <div style="margin-bottom:22px; padding:0 8px; font-size:14px; line-height:2; color:${t.text}; text-indent:1em;">${parseMarkdown(content, t)}</div>`;
                });
            });

            const contentBlock = `
                <div style="padding:30px 24px; background:${t.contentBg}; ${t.stripeBg};">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:28px; padding-bottom:16px; border-bottom:1px dashed ${t.divider};">
                        <span style="font-size:10px; color:${t.textMuted}; letter-spacing:0.15em; text-transform:uppercase;">${info}</span>                       
                    </div>
                    ${logsHTML}
                </div>`;

            const chapterHeader = `
                <div style="padding:20px 24px 16px; background-color:${t.headerBg}; border-bottom:1px solid ${t.divider}; text-align:center;">
                    <div style="font-size:9px; letter-spacing:0.4em; color:${t.textMuted}; text-transform:uppercase; margin-bottom:6px;">Chapter</div>
                    <div style="font-size:32px; font-weight:100; color:${t.textMuted}; opacity:0.3; font-family:Georgia,serif; margin-bottom:4px;">${String(idx+1).padStart(2,'0')}</div>
                    <div style="font-size:15px; font-weight:500; color:${t.text}; letter-spacing:0.06em;">${title}</div>
                    <div style="width:30px; height:1px; background:${t.accent}; margin:10px auto 0;"></div>
                </div>`;

            if (useCollapse) {
                chaptersHTML += `
                <details style="border-top:1px solid ${t.divider};" ${idx === 0 ? 'open' : ''}>
                    <summary style="list-style:none; padding:20px 24px 16px; background-color:${t.headerBg}; cursor:pointer; text-align:center;">
                        <div style="font-size:9px; letter-spacing:0.4em; color:${t.textMuted}; text-transform:uppercase; margin-bottom:6px;">Chapter</div>
                        <div style="font-size:32px; font-weight:100; color:${t.textMuted}; opacity:0.3; font-family:Georgia,serif; margin-bottom:4px;">${String(idx+1).padStart(2,'0')}</div>
                        <div style="font-size:15px; font-weight:500; color:${t.text}; letter-spacing:0.06em;">${title}</div>
                        <div style="width:30px; height:1px; background:${t.accent}; margin:10px auto 0;"></div>
                    </summary>
                    ${contentBlock}
                </details>`;
            } else {
                chaptersHTML += `<div style="border-top:1px solid ${t.divider};">${chapterHeader}${contentBlock}</div>`;
            }
        });

        // â”€â”€ ê°ì£¼ ì„¹ì…˜ â”€â”€
        let footnotesHTML = '';
        const fnKeys = Object.keys(footnotes);
        if (fnKeys.length > 0) {
            let fnItems = fnKeys.map(k => 
                `<div style="margin-bottom:6px;"><span style="font-size:10px; font-weight:600; color:${t.accent}; margin-right:8px;">[${k}]</span><span style="font-size:11px; color:${t.textSoft}; line-height:1.7;">${footnotes[k]}</span></div>`
            ).join('');
            footnotesHTML = `
            <div style="padding:24px 28px; background:${t.headerBg}; border-top:1px solid ${t.divider};">
                <div style="margin-bottom:14px;"><span style="font-size:9px; font-weight:500; letter-spacing:0.3em; color:${t.textMuted}; text-transform:uppercase;">Notes</span></div>
                ${fnItems}
            </div>`;
        }

        // â”€â”€ ì½”ë©˜íŠ¸ â”€â”€
        const commentHTML = showNote ? `
        <div style="padding:32px 28px; background-color:${t.headerBg}; border-top:1px solid ${t.divider}; text-align:center;">
            <div style="margin-bottom:18px;"><span style="font-size:9px; font-weight:500; letter-spacing:0.3em; color:${t.textMuted}; text-transform:uppercase;">Note</span></div>
            <div style="font-size:13px; line-height:2; color:${t.textSoft};">${commentText.replace(/\n/g,'<br>')}</div>
        </div>` : '';

        // â”€â”€ í‘¸í„° â”€â”€
        const footerHTML = `
        <div style="padding:14px 24px; background-color:${t.contentBg}; border-top:1px solid ${t.divider}; text-align:center;">
            <span style="font-size:9px; color:${t.textMuted}; font-family:'Courier New',Courier,monospace; letter-spacing:0.1em;">CH.${document.querySelectorAll('.chapter-box').length}</span>
            <span style="font-size:9px; color:${t.textMuted}; margin:0 8px;">Â·</span>
            <span style="font-size:9px; color:${t.textMuted}; font-family:'Courier New',Courier,monospace;">by ${authorName}</span>
        </div>`;

        // â”€â”€ ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ (í‘œì§€) â”€â”€
        const preloadImg = coverImg && coverLayout !== 'noimage' ? `<p><img style="width:0px;height:0px;" src="${coverImg}"></p>` : '';

        return `${preloadImg}
<div style="max-width:680px; margin:0 auto; font-family:${font}; background:${t.wrapBg}; overflow:hidden;">
    <div style="background:${t.cardBg}; border:1px solid ${t.border}; overflow:hidden;">
        ${coverHTML}
        ${charIntroHTML}
        ${chaptersHTML}
        ${footnotesHTML}
        ${commentHTML}
        ${footerHTML}
    </div>
</div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ë Œë”ë§ & ê¸€ììˆ˜
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderPreview() {
        if (!livePreviewEnabled) return;
        document.getElementById('preview-container').innerHTML = generateFullHTML();
        // ê¸€ì ìˆ˜ (charCount ìš”ì†Œê°€ ì œê±°ë˜ì—ˆìœ¼ë¯€ë¡œ ì´ ë¶€ë¶„ì€ ìƒëµ)
        updateTimeline(); // íƒ€ì„ë¼ì¸ ìë™ ì—…ë°ì´íŠ¸
    }
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  HTML ë³µì‚¬
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function copyCode() {
        const code = generateFullHTML();
        navigator.clipboard.writeText(code).then(() => {
            alert("âœ… HTML ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }).catch(() => {
            const ta = document.createElement("textarea");
            ta.value = code; ta.style.cssText = "position:fixed;left:-9999px;";
            document.body.appendChild(ta); ta.select();
            document.execCommand('copy'); document.body.removeChild(ta);
            alert("âœ… HTML ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ì´ë¯¸ì§€ íƒœê·¸ ë³µì‚¬
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function copyImgTag(type) {
        const t = getActiveTheme();
        let tag = '';
        if (type === 'basic') {
            tag = `<div style="margin:32px 0; text-align:center;">\n    <img src="ì—¬ê¸°ì—_ì´ë¯¸ì§€_URL" style="max-width:100%; border-radius:8px; border:1px solid ${t.border};">\n</div>`;
        } else if (type === 'caption') {
            tag = `<div style="margin:32px 0; text-align:center;">\n    <img src="ì—¬ê¸°ì—_ì´ë¯¸ì§€_URL" style="max-width:100%; border-radius:8px; border:1px solid ${t.border};">\n    <div style="font-size:10px; color:${t.textMuted}; margin-top:8px; font-style:italic;">ìº¡ì…˜ í…ìŠ¤íŠ¸</div>\n</div>`;
        } else if (type === 'full') {
            tag = `<div style="margin:40px -24px; height:200px; background:url('ì—¬ê¸°ì—_ì´ë¯¸ì§€_URL') center/cover no-repeat;"></div>`;
        }
        navigator.clipboard.writeText(tag).then(() => alert('âœ… ì´ë¯¸ì§€ íƒœê·¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!')).catch(() => alert('âš ï¸ ë³µì‚¬ ì‹¤íŒ¨'));
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PDF / ì´ë¯¸ì§€ ì¶œë ¥
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function exportPDF() {
        const el = document.getElementById('preview-container');
        const opt = {
            margin: 0, filename: 'archive-log.pdf',
            image: { type: 'jpeg', quality: 0.95 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(el).save();
    }

    function exportImage() {
        const el = document.getElementById('preview-container');
        html2canvas(el, { scale: 2, useCORS: true, backgroundColor: null }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'archive-log.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  JSON ì €ì¥ / ë¶ˆëŸ¬ì˜¤ê¸°
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function exportJSON() {
        const data = {
            coverTitle: document.getElementById('coverTitle').value,
            coverSubtitle: document.getElementById('coverSubtitle').value,
            coverImg: document.getElementById('coverImg').value,
            dateText: document.getElementById('dateText').value,
            tagText: document.getElementById('tagText').value,
            hashTags: document.getElementById('hashTags').value,
            authorName: document.getElementById('authorName').value,
            commentText: document.getElementById('commentText').value,
            showNote: document.getElementById('showNote').checked,
            showCharIntro: document.getElementById('showCharIntro').checked,
            useCollapse: document.getElementById('useCollapse').checked,
            coverLayout,
            currentTheme,
            fontSelect: document.getElementById('fontSelect').value,
            customFontName: document.getElementById('customFontName').value,
            characters: characters.map(c => ({ name: c.name, color: c.color, img: c.img, desc: c.desc })),
            relation12: document.getElementById('relation12').value,
            relation21: document.getElementById('relation21').value,
            gradColor1: document.getElementById('gradColor1').value,
            gradColor2: document.getElementById('gradColor2').value,
            gradAngle: document.getElementById('gradAngle').value,
            chapters: []
        };
        document.querySelectorAll('.chapter-box').forEach(chap => {
            const logs = [];
            chap.querySelectorAll('.log-content').forEach(l => logs.push(l.value));
            data.chapters.push({
                title: chap.querySelector('.chap-title').value,
                info: chap.querySelector('.chap-info').value,
                logs
            });
        });
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'archive-log.json';
        a.click();
    }

    function importJSON(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                // ê¸°ë³¸ í•„ë“œ
                document.getElementById('coverTitle').value = data.coverTitle || '';
                document.getElementById('coverSubtitle').value = data.coverSubtitle || '';
                document.getElementById('coverImg').value = data.coverImg || '';
                document.getElementById('dateText').value = data.dateText || '';
                document.getElementById('tagText').value = data.tagText || '';
                document.getElementById('hashTags').value = data.hashTags || '';
                document.getElementById('authorName').value = data.authorName || '';
                document.getElementById('commentText').value = data.commentText || '';
                document.getElementById('showNote').checked = data.showNote !== false;
                document.getElementById('showCharIntro').checked = data.showCharIntro !== false;
                document.getElementById('useCollapse').checked = data.useCollapse !== false;
                document.getElementById('relation12').value = data.relation12 || '';
                document.getElementById('relation21').value = data.relation21 || '';
                document.getElementById('gradColor1').value = data.gradColor1 || '#0a0a1a';
                document.getElementById('gradColor2').value = data.gradColor2 || '#1a1a3a';
                document.getElementById('gradAngle').value = data.gradAngle || 135;

                // í…Œë§ˆ
                if (data.currentTheme && themes[data.currentTheme]) {
                    currentTheme = data.currentTheme;
                    document.querySelectorAll('.theme-opt').forEach(o => o.classList.remove('active'));
                    // í•´ë‹¹ í…Œë§ˆ ë²„íŠ¼ì— active ì¶”ê°€
                    const themeNames = ['obsidian','vintage','cherry','pure','violet'];
                    const thIdx = themeNames.indexOf(currentTheme);
                    if (thIdx >= 0) document.querySelectorAll('.theme-opt')[thIdx].classList.add('active');
                }

                // ì»¤ë²„ ë ˆì´ì•„ì›ƒ
                if (data.coverLayout) {
                    coverLayout = data.coverLayout;
                    document.querySelectorAll('.layout-opt').forEach(o => o.classList.remove('active'));
                    const layouts = ['default','noimage','split'];
                    const lIdx = layouts.indexOf(coverLayout);
                    if (lIdx >= 0) document.querySelectorAll('.layout-opt')[lIdx].classList.add('active');
                    document.getElementById('coverImgSection').style.display = coverLayout === 'noimage' ? 'none' : 'block';
                    document.getElementById('gradientSection').style.display = coverLayout === 'noimage' ? 'block' : 'none';
                }

                // í°íŠ¸
                if (data.fontSelect) {
                    document.getElementById('fontSelect').value = data.fontSelect;
                    onFontChange();
                }
                if (data.customFontName) document.getElementById('customFontName').value = data.customFontName;

                // ì¸ë¬¼
                characters = [];
                charIdCounter = 0;
                if (data.characters && data.characters.length) {
                    data.characters.forEach(c => addCharacter(c.name, c.color, c.img, c.desc));
                }

                // ì±•í„°
                document.getElementById('chapters-container').innerHTML = '';
                chapterCount = 0;
                if (data.chapters && data.chapters.length) {
                    data.chapters.forEach(ch => {
                        addChapter();
                        const chapEl = document.getElementById('chapters-container').lastElementChild;
                        chapEl.querySelector('.chap-title').value = ch.title;
                        chapEl.querySelector('.chap-info').value = ch.info;
                        // ê¸°ë³¸ ë¡œê·¸ ì œê±° í›„ ë°ì´í„° ë¡œê·¸ ì¶”ê°€
                        const logsContainer = chapEl.querySelector('[id^="logs-"]');
                        logsContainer.innerHTML = '';
                        ch.logs.forEach(logText => {
                            addLog(chapEl.id);
                            const lastLog = logsContainer.lastElementChild;
                            lastLog.querySelector('.log-content').value = logText;
                        });
                    });
                }

                renderPreview();
                alert('âœ… ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
            } catch (err) {
                alert('âš ï¸ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + err.message);
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  í™•ëŒ€ í¸ì§‘ ëª¨ë‹¬
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openBigEditor(logId) {
        const textarea = document.getElementById(logId).querySelector('textarea');
        currentEditingTextarea = textarea;
        document.getElementById('bigEditorTextarea').value = textarea.value;
        document.getElementById('bigEditorShortcuts').innerHTML = getShortcutButtonsHTML(logId, true);
        document.getElementById('bigEditorModal').style.display = 'block';
        document.getElementById('bigEditorTextarea').focus();
    }
    function closeBigEditor() {
        document.getElementById('bigEditorModal').style.display = 'none';
        currentEditingTextarea = null;
    }
    function saveBigEditor() {
        if (currentEditingTextarea) {
            currentEditingTextarea.value = document.getElementById('bigEditorTextarea').value;
            renderPreview();
        }
        closeBigEditor();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ìƒˆë¡œìš´ ê¸°ëŠ¥ë“¤
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // ìë™ ì €ì¥
    function startAutoSave() {
        autoSaveInterval = setInterval(() => {
            autoSave();
        }, 120000); // 2ë¶„
    }

    function autoSave() {
        const data = getCurrentData();
        const timestamp = new Date().toLocaleString('ko-KR');
        
        autoSaveSlots.unshift({ timestamp, data });
        
        if (autoSaveSlots.length > MAX_AUTOSAVE_SLOTS) {
            autoSaveSlots = autoSaveSlots.slice(0, MAX_AUTOSAVE_SLOTS);
        }
        
        localStorage.setItem('autoSaveSlots', JSON.stringify(autoSaveSlots));
        document.getElementById('lastSaveTime').textContent = `ë§ˆì§€ë§‰ ì €ì¥: ${timestamp}`;
    }

    function loadAutoSaveSlots() {
        const saved = localStorage.getItem('autoSaveSlots');
        if (saved) {
            autoSaveSlots = JSON.parse(saved);
            if (autoSaveSlots.length > 0) {
                document.getElementById('lastSaveTime').textContent = `ë§ˆì§€ë§‰ ì €ì¥: ${autoSaveSlots[0].timestamp}`;
            }
        }
    }

    function getCurrentData() {
        return {
            coverTitle: document.getElementById('coverTitle').value,
            coverSubtitle: document.getElementById('coverSubtitle').value,
            coverImg: document.getElementById('coverImg').value,
            dateText: document.getElementById('dateText').value,
            tagText: document.getElementById('tagText').value,
            hashTags: document.getElementById('hashTags').value,
            coverLayout, currentTheme,
            characters: characters.map(c => ({ name: c.name, color: c.color, img: c.img, desc: c.desc })),
            relation12: document.getElementById('relation12').value,
            relation21: document.getElementById('relation21').value,
            chapters: Array.from(document.querySelectorAll('.chapter-box')).map(chap => ({
                title: chap.querySelector('.chap-title').value,
                info: chap.querySelector('.chap-info').value,
                logs: Array.from(chap.querySelectorAll('.log-content')).map(l => l.value)
            }))
        };
    }

    function openAutoSaveModal() {
        const slotsHtml = autoSaveSlots.length === 0
            ? '<div class="slot-item-empty">ì €ì¥ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>'
            : autoSaveSlots.map((slot, idx) => `
                <div class="slot-item" onclick="loadAutoSaveSlot(${idx})">
                    <div class="slot-item-title">ìŠ¬ë¡¯ ${idx + 1}</div>
                    <div class="slot-item-time">${slot.timestamp}</div>
                </div>
            `).join('');
        
        document.getElementById('autoSaveSlots').innerHTML = slotsHtml;
        document.getElementById('autoSaveModal').classList.add('active');
    }

    function closeAutoSaveModal() {
        document.getElementById('autoSaveModal').classList.remove('active');
    }

    function loadAutoSaveSlot(idx) {
        if (confirm('í˜„ì¬ ì‘ì—… ë‚´ìš©ì„ ìƒì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            loadDataFromObject(autoSaveSlots[idx].data);
            closeAutoSaveModal();
            alert('âœ… ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
        }
    }

    function loadDataFromObject(data) {
        document.getElementById('coverTitle').value = data.coverTitle || '';
        document.getElementById('coverSubtitle').value = data.coverSubtitle || '';
        document.getElementById('coverImg').value = data.coverImg || '';
        document.getElementById('dateText').value = data.dateText || '';
        document.getElementById('tagText').value = data.tagText || '';
        document.getElementById('hashTags').value = data.hashTags || '';
        if (data.coverLayout) coverLayout = data.coverLayout;
        if (data.currentTheme) currentTheme = data.currentTheme;
        
        characters = [];
        charIdCounter = 0;
        if (data.characters) {
            data.characters.forEach(c => addCharacter(c.name, c.color, c.img, c.desc));
        }
        
        document.getElementById('chapters-container').innerHTML = '';
        chapterCount = 0;
        if (data.chapters) {
            data.chapters.forEach(ch => {
                addChapter();
                const chapEl = document.getElementById('chapters-container').lastElementChild;
                chapEl.querySelector('.chap-title').value = ch.title;
                chapEl.querySelector('.chap-info').value = ch.info;
                const logsContainer = chapEl.querySelector('[id^="logs-"]');
                logsContainer.innerHTML = '';
                ch.logs.forEach(logText => {
                    addLog(chapEl.id);
                    logsContainer.lastElementChild.querySelector('.log-content').value = logText;
                });
            });
        }
        
        renderPreview();
    }

    // ê²€ìƒ‰ & ì¹˜í™˜
    function openSearchModal() {
        document.getElementById('searchModal').classList.add('active');
        document.getElementById('searchInput').focus();
    }

    function closeSearchModal() {
        document.getElementById('searchModal').classList.remove('active');
    }

    function performSearch() {
        const query = document.getElementById('searchInput').value;
        if (!query) return;
        
        const results = [];
        document.querySelectorAll('.log-content').forEach((textarea, idx) => {
            const content = textarea.value;
            if (content.toLowerCase().includes(query.toLowerCase())) {
                const preview = content.substring(0, 50) + '...';
                results.push({ textarea, preview, idx });
            }
        });
        
        const resultsHtml = results.length === 0
            ? '<div class="slot-item-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>'
            : results.map(r => `
                <div class="search-result-item" onclick="jumpToLog(${r.idx})">
                    ë¡œê·¸ #${r.idx + 1}
                    <div class="search-result-preview">${r.preview}</div>
                </div>
            `).join('');
        
        document.getElementById('searchResults').innerHTML = resultsHtml;
    }

    function performReplace() {
        const query = document.getElementById('searchInput').value;
        const replacement = document.getElementById('replaceInput').value;
        if (!query) return;
        
        const textarea = document.querySelector('.log-content:focus');
        if (textarea) {
            textarea.value = textarea.value.replace(query, replacement);
            renderPreview();
        }
    }

    function performReplaceAll() {
        const query = document.getElementById('searchInput').value;
        const replacement = document.getElementById('replaceInput').value;
        if (!query) return;
        
        if (!confirm(`ëª¨ë“  "${query}"ë¥¼ "${replacement}"ë¡œ ì¹˜í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        
        let count = 0;
        document.querySelectorAll('.log-content').forEach(textarea => {
            const before = textarea.value;
            textarea.value = textarea.value.replaceAll(query, replacement);
            if (textarea.value !== before) count++;
        });
        
        alert(`âœ… ${count}ê°œ ë¡œê·¸ì—ì„œ ì¹˜í™˜ ì™„ë£Œ!`);
        renderPreview();
        closeSearchModal();
    }

    function jumpToLog(idx) {
        const textareas = document.querySelectorAll('.log-content');
        if (textareas[idx]) {
            switchTab('content');
            setTimeout(() => {
                textareas[idx].scrollIntoView({ behavior: 'smooth', block: 'center' });
                textareas[idx].focus();
            }, 100);
            closeSearchModal();
        }
    }

    // íƒ€ì„ë¼ì¸
    function toggleTimeline() {
        const timeline = document.getElementById('timelineView');
        if (timeline.style.display === 'none') {
            updateTimeline();
            timeline.style.display = 'block';
        } else {
            timeline.style.display = 'none';
        }
    }

    function updateTimeline() {
        const chapters = document.querySelectorAll('.chapter-box');
        const html = Array.from(chapters).map((chap, idx) => {
            const title = chap.querySelector('.chap-title').value || `ì±•í„° ${idx + 1}`;
            const info = chap.querySelector('.chap-info').value || '';
            return `
                <div class="timeline-item" onclick="jumpToChapter(${idx})">
                    <div class="timeline-item-title">${title}</div>
                    <div class="timeline-item-info">${info}</div>
                </div>
            `;
        }).join('');
        
        document.getElementById('timelineContent').innerHTML = html;
    }

    function jumpToChapter(idx) {
        const chapters = document.querySelectorAll('.chapter-box');
        if (chapters[idx]) {
            switchTab('content');
            setTimeout(() => {
                chapters[idx].scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    }

    // ë¯¸ë¦¬ë³´ê¸° í–¥ìƒ
    function zoomPreview(delta) {
        previewZoom = Math.max(0.5, Math.min(2.0, previewZoom + delta));
        document.getElementById('preview-container').style.transform = `scale(${previewZoom})`;
        document.getElementById('zoomValue').textContent = `${Math.round(previewZoom * 100)}%`;
    }

    function toggleLivePreview() {
        livePreviewEnabled = document.getElementById('livePreview').checked;
        if (livePreviewEnabled) {
            renderPreview();
        }
    }


    // ë‹¨ì¶•í‚¤
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            autoSave();
            alert('ğŸ’¾ ì €ì¥ ì™„ë£Œ!');
        }
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            openSearchModal();
        }
        if (e.ctrlKey && e.key === 't') {
            e.preventDefault();
            toggleTimeline();
        }
        if (e.key === 'Escape') {
            closeSearchModal();
            closeAutoSaveModal();
            closeTemplateModal();
        }
    });

    // ë‹¨ì¶•í‚¤ íŒíŠ¸
    setTimeout(() => {
        document.getElementById('shortcutHint').classList.add('active');
        setTimeout(() => {
            document.getElementById('shortcutHint').classList.remove('active');
        }, 5000);
    }, 1000);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ì´ˆê¸°í™”
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    window.onload = () => {
        loadSavedCustomTheme();
        loadAutoSaveSlots();
        startAutoSave();
        addCharacter('Name A', '#E8A0B0', '', 'ìºë¦­í„° ì†Œê°œ');
        addCharacter('Name B', '#90C0E0', '', 'ìºë¦­í„° ì†Œê°œ');
        addChapter();
        renderPreview();
    };
</script>
</body>
</html>